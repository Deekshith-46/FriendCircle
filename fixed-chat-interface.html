<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Chat Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            height: 80vh;
        }
        .sidebar {
            width: 300px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .chat-area {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .message-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        .sent {
            background: #dcf8c6;
            margin-left: auto;
        }
        .received {
            background: white;
            margin-right: auto;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #075e54;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #064e47;
        }
        .room-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .room-item:hover {
            background: #f0f0f0;
        }
        .badge {
            background: #ff6b6b;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Fixed Chat Interface</h1>
    
    <div class="status" id="status">Disconnected</div>
    
    <div class="container">
        <div class="sidebar">
            <h3>Chats</h3>
            <div id="rooms"></div>
        </div>
        
        <div class="chat-area">
            <div id="chat-header">
                <h3 id="room-name">Select a chat</h3>
            </div>
            <div class="message-box" id="box"></div>
            <div class="input-area">
                <input type="text" id="msg" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let socket = null;
        let currentRoom = null;
        let activeRoomId = null;
        let currentUser = null;

        // DOM elements
        const box = document.getElementById('box');
        const msg = document.getElementById('msg');
        const rooms = document.getElementById('rooms');
        const status = document.getElementById('status');
        const roomName = document.getElementById('room-name');

        // Form inputs (you'll need to add these to your HTML or get from somewhere)
        const api = { value: 'http://localhost:5001' }; // Replace with your API URL
        const token = { value: '' }; // Replace with actual token

        // Decode JWT token to get user info
        function decode() {
            if (!token.value) return;
            try {
                const payload = JSON.parse(atob(token.value.split('.')[1]));
                currentUser = {
                    id: payload.id,
                    type: payload.type
                };
            } catch (e) {
                console.error('Invalid token');
            }
        }

        // Initialize socket connection
        async function init(){
            try {
                decode();

                if (!token.value) {
                    alert("Please paste JWT token");
                    return;
                }

                socket = io(api.value, {
                    auth: {
                        token: token.value
                    }
                });

                socket.on("connect", () => {
                    console.log("Socket connected:", socket.id);
                    status.textContent = `Connected - ID: ${socket.id}`;
                    status.className = 'status connected';
                    loadRooms();
                });

                socket.on("connect_error", (err) => {
                    console.error("Socket error:", err);
                    status.textContent = `Connection Error: ${err.message}`;
                    status.className = 'status disconnected';
                });

                socket.on("newMessage", onNewMessage);
                socket.on("messageRead", updateTicks);
                socket.on("typing", onTyping);

            } catch (e) {
                alert("Invalid JWT format");
            }
        }

        // Load chat rooms
        async function loadRooms(){
            if (!token.value) return;
            
            try {
                const res = await fetch(`${api.value}/chat/rooms`, {
                    headers: { Authorization: "Bearer " + token.value }
                });
                const json = await res.json();
                
                rooms.innerHTML = "";
                (json.data || []).forEach(r => {
                    const div = document.createElement("div");
                    div.className = "room-item";
                    div.onclick = () => openRoom(r);
                    
                    let name = r.name;
                    if (!name) {
                        // Try to get other participant name
                        const other = r.participants.find(p => p.userId != currentUser.id);
                        name = other ? `${other.userType.charAt(0).toUpperCase() + other.userType.slice(1)} User` : "Chat";
                    }
                    
                    div.innerHTML = `
                        ${name}
                        ${r.unreadCount > 0 ? `<span class="badge">${r.unreadCount}</span>` : ''}
                    `;
                    rooms.appendChild(div);
                });
            } catch (e) {
                console.error("Error loading rooms:", e);
            }
        }

        // Open a chat room
        function openRoom(r) {
            currentRoom = r;
            activeRoomId = r._id;
            roomName.textContent = r.name || "Chat Room";
            loadMessages();
        }

        // Load messages for current room
        async function loadMessages(){
            if (!currentRoom || !token.value) return;
            
            try {
                const res = await fetch(`${api.value}/chat/${currentRoom._id}/messages`, {
                    headers: { Authorization: "Bearer " + token.value }
                });
                const json = await res.json();
                
                box.innerHTML = "";
                const unreadIds = [];

                (json.data || []).forEach(m => {
                    render(m);
                    if (m.senderType !== currentUser.type) {
                        unreadIds.push(m._id);
                    }
                });

                // Mark all messages as read when opening the room
                if (unreadIds.length > 0) {
                    socket.emit("markAsRead", {
                        roomId: currentRoom._id,
                        messageIds: unreadIds
                    });
                    
                    // Refresh rooms after a delay to update unread counts
                    setTimeout(loadRooms, 300);
                }
            } catch (e) {
                console.error("Error loading messages:", e);
            }
        }

        // Render a message
        function render(m) {
            const div = document.createElement("div");
            div.className = `message ${m.senderType === currentUser.type ? 'sent' : 'received'}`;
            
            let content = m.content;
            if (m.type === 'image') content = '[Image]';
            else if (m.type === 'video') content = '[Video]';
            else if (m.type === 'audio') content = '[Audio]';
            
            div.innerHTML = `
                <strong>${m.senderType.toUpperCase()}:</strong> ${content}
                <br><small>${new Date(m.createdAt).toLocaleTimeString()}</small>
            `;
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // Handle new message
        function onNewMessage(m){
            if (m.chatRoomId !== activeRoomId) {
                // Different room - show notification and refresh rooms
                showBrowserNotification(m);
                loadRooms(); // Refresh unread count
                return;
            }

            render(m);

            // Mark message as read immediately
            socket.emit("markAsRead", {
                roomId: currentRoom._id,
                messageIds: [m._id]
            });

            // Refresh rooms after a delay to update unread counts
            setTimeout(loadRooms, 300);
        }

        // Send message
        function sendMessage() {
            if (!currentRoom || !msg.value.trim()) return;

            socket.emit("sendMessage", {
                roomId: currentRoom._id,
                type: "text",
                content: msg.value
            });

            msg.value = "";
        }

        // Show browser notification
        function showBrowserNotification(m) {
            if (Notification.permission === "granted") {
                new Notification("New Message", {
                    body: m.content,
                    icon: "/favicon.ico"
                });
            }
        }

        // Update message read status
        function updateTicks(data) {
            console.log("Message read by:", data.readerType);
            // Refresh rooms to update unread counts
            setTimeout(loadRooms, 100);
        }

        // Handle typing indicator
        function onTyping(data) {
            console.log("User is typing...");
        }

        // Initialize when page loads
        window.onload = function() {
            // Set your API URL and token here
            api.value = 'http://localhost:5001'; // Replace with your actual API URL
            token.value = 'YOUR_JWT_TOKEN_HERE'; // Replace with actual token
            
            // You'll need to get the actual token from your authentication system
            // For now, you can temporarily set it if you have a way to get it
            init();
        };

        // Handle Enter key for sending messages
        msg.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>