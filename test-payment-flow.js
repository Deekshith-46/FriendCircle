// Simple test to simulate a frontend payment flow
require('dotenv').config();
const axios = require('axios');

async function testPaymentFlow() {
  try {
    console.log('üöÄ Starting payment flow test...');
    
    // 1. Login as male user
    console.log('1. Logging in as male user...');
    // First request OTP
    await axios.post('http://localhost:5001/male-user/login', {
      email: 'maleA123@gmail.com',
      password: '12345678'
    });
    
    // Then verify OTP (using the OTP from previous response)
    const loginResponse = await axios.post('http://localhost:5001/male-user/verify-login-otp', {
      otp: 5625
    });
    
    const token = loginResponse.data.token;
    console.log('‚úÖ Login successful');
    
    // 2. Get coin packages
    console.log('2. Getting coin packages...');
    const packagesResponse = await axios.get('http://localhost:5001/male-user/payment/packages', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    const packages = packagesResponse.data.data;
    console.log(`‚úÖ Found ${packages.length} packages`);
    console.log('Available packages:', packages.map(p => `${p.coin} coins for ‚Çπ${p.amount}`));
    
    // 3. Create coin order (simulate frontend)
    console.log('3. Creating coin order...');
    const packageId = packages[0]._id; // Use first package
    const createOrderResponse = await axios.post('http://localhost:5001/male-user/payment/coin/order', {
      packageId: packageId
    }, {
      headers: { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const orderData = createOrderResponse.data.data;
    console.log('‚úÖ Order created:', {
      orderId: orderData.orderId,
      amount: orderData.amount,
      coins: orderData.coins
    });
    
    // 4. Simulate Razorpay payment completion (this would normally happen in frontend)
    console.log('4. Simulating Razorpay payment completion...');
    
    // In a real scenario, Razorpay would provide these values
    const mockRazorpayResponse = {
      razorpay_order_id: orderData.orderId,
      razorpay_payment_id: `pay_test_${Date.now()}`,
      razorpay_signature: 'mock_signature_for_testing' // This would be generated by Razorpay
    };
    
    console.log('Mock Razorpay response:', mockRazorpayResponse);
    
    // 5. Call verifyPayment API (this is what the frontend should do)
    console.log('5. Calling verifyPayment API...');
    const verifyResponse = await axios.post('http://localhost:5001/male-user/payment/verify', {
      razorpay_order_id: mockRazorpayResponse.razorpay_order_id,
      razorpay_payment_id: mockRazorpayResponse.razorpay_payment_id,
      razorpay_signature: mockRazorpayResponse.razorpay_signature
    }, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('‚úÖ Payment verification response:', verifyResponse.data);
    
    // 6. Check if admin earnings increased
    console.log('6. Checking admin earnings...');
    const adminLoginResponse = await axios.post('http://localhost:5001/admin/login', {
      email: 'admin@gmail.com',
      password: '12345678',
      userType: 'admin'
    });
    
    const adminToken = adminLoginResponse.data.data.token;
    
    const earningsResponse = await axios.get('http://localhost:5001/admin/earnings/summary', {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    
    console.log('‚úÖ Admin earnings updated:', {
      totalEarnings: earningsResponse.data.data.totalEarnings,
      count: earningsResponse.data.data.earningsBySource[0]?.count
    });
    
    console.log('\nüéâ Payment flow test completed successfully!');
    
  } catch (error) {
    console.error('‚ùå Payment flow test failed:');
    if (error.response) {
      console.error('Status:', error.response.status);
      console.error('Data:', error.response.data);
    } else {
      console.error('Error:', error.message);
    }
  }
}

testPaymentFlow();