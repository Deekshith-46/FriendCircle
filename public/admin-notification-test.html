<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîî Admin Notification Test Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ‚úÖ Socket.IO CDN (NO /socket.io PATH ISSUES) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: #f3f4f6;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-right: 6px;
    }

    .btn-primary { background: #2563eb; color: #fff; }
    .btn-danger { background: #dc2626; color: #fff; }
    .btn-secondary { background: #6b7280; color: #fff; }

    .status {
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-weight: 600;
    }

    .connected { background: #dcfce7; color: #166534; }
    .disconnected { background: #fee2e2; color: #991b1b; }

    .notification {
      background: #f9fafb;
      border-left: 4px solid #2563eb;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .log {
      background: #020617;
      color: #22c55e;
      font-family: monospace;
      font-size: 13px;
      padding: 10px;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>

<h1>üîî Admin Notification System ‚Äì Test Panel</h1>

<!-- CONFIG -->
<div class="card">
  <h3>‚öôÔ∏è Configuration</h3>

  <input id="serverUrl" value="http://localhost:5001" placeholder="Backend Server URL" />
  <input id="jwtToken" placeholder="Admin JWT Token" />

  <button class="btn-primary" onclick="connectSocket()">Connect WebSocket</button>

  <div id="connectionStatus" class="status disconnected">‚ùå Disconnected</div>
</div>

<!-- ADMIN API TEST -->
<div class="card">
  <h3>üõ† Admin API Test</h3>

  <select id="userType">
    <option value="female">Female</option>
    <option value="agency">Agency</option>
  </select>

  <input id="targetId" placeholder="Target User ID / Withdrawal ID" />

  <button class="btn-primary" onclick="approve()">Approve</button>
  <button class="btn-danger" onclick="reject()">Reject</button>
</div>

<!-- NOTIFICATIONS -->
<div class="card">
  <h3>üì© Received Notifications</h3>
  <button class="btn-secondary" onclick="clearNotifications()">Clear</button>
  <div id="notifications"></div>
</div>

<!-- DEBUG -->
<div class="card">
  <h3>üß™ Debug Log</h3>
  <div id="log" class="log"></div>
</div>

<script>
let socket;

/* ---------- UTILS ---------- */
function log(msg) {
  const el = document.getElementById('log');
  el.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  el.scrollTop = el.scrollHeight;
}

function setStatus(connected) {
  const el = document.getElementById('connectionStatus');
  el.className = 'status ' + (connected ? 'connected' : 'disconnected');
  el.textContent = connected ? '‚úÖ Connected to WebSocket' : '‚ùå Disconnected';
}

/* ---------- SOCKET ---------- */
function connectSocket() {
  const url = document.getElementById('serverUrl').value;
  const token = document.getElementById('jwtToken').value;

  if (!token) {
    alert('Please enter Admin JWT token');
    return;
  }

  if (socket) socket.disconnect();

  log('Connecting to socket...');

  socket = io(url, {
    auth: { token }   // ‚úÖ DO NOT FORCE websocket
  });

  socket.on('connect', () => {
    log('Socket connected: ' + socket.id);
    setStatus(true);

    socket.emit('join_admin_notifications');
    log('Joined admins_room');
  });

  socket.on('disconnect', () => {
    log('Socket disconnected');
    setStatus(false);
  });

  socket.on('connect_error', err => {
    log('Connection error: ' + err.message);
    setStatus(false);
  });

  socket.on('notification', data => {
    log('Notification received');
    renderNotification(data);
    browserNotify(data);
  });
}

/* ---------- UI ---------- */
function renderNotification(data) {
  const box = document.getElementById('notifications');
  const div = document.createElement('div');
  div.className = 'notification';
  div.innerHTML = `
    <strong>${data.title || 'Notification'}</strong><br>
    ${data.message || ''}<br>
    <small>${new Date().toLocaleString()}</small>
  `;
  box.prepend(div);
}

function clearNotifications() {
  document.getElementById('notifications').innerHTML = '';
}

/* ---------- BROWSER NOTIFICATION ---------- */
function browserNotify(data) {
  if (!('Notification' in window)) return;

  if (Notification.permission === 'granted') {
    new Notification(data.title || 'Admin Notification', {
      body: data.message || ''
    });
  } else {
    Notification.requestPermission();
  }
}

/* ---------- ADMIN API ---------- */
async function approve() {
  await callAdminApi('approve');
}

async function reject() {
  await callAdminApi('reject');
}

async function callAdminApi(action) {
  const base = document.getElementById('serverUrl').value;
  const token = document.getElementById('jwtToken').value;
  const type = document.getElementById('userType').value;
  const id = document.getElementById('targetId').value;

  if (!id) {
    alert('Enter target ID');
    return;
  }

  const endpoint = `${base}/admin/users/${type}/${id}/${action}`;
  log(`Calling ${endpoint}`);

  const res = await fetch(endpoint, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });

  const json = await res.json();
  log(JSON.stringify(json));
}
</script>

</body>
</html>
